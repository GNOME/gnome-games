From cf7f13cf73430c8cc29792c784e0acf01c36b1e6 Mon Sep 17 00:00:00 2001
From: Adrien Plazas <kekun.plazas@laposte.net>
Date: Fri, 10 Mar 2017 07:24:33 +0100
Subject: [PATCH] libretro: Remove reset in retro_run() hack

Removes a hack breaking deserialization when running retro_reset(),
retro_unserialize() and retro_run() in this order, as it silently resets
the core just after setting its state.
---
 frontend/libretro.c | 32 +-------------------------------
 1 file changed, 1 insertion(+), 31 deletions(-)

diff --git a/frontend/libretro.c b/frontend/libretro.c
index 3e2c64a..a80924e 100644
--- a/frontend/libretro.c
+++ b/frontend/libretro.c
@@ -71,9 +71,6 @@ void new_dyna_after_save(void) { }
 void new_dyna_freeze(void *f, int i) { }
 #endif
 
-//hack to prevent retroarch freezing when reseting in the menu but not while running with the hot key
-static int rebootemu = 0;
-
 static retro_video_refresh_t video_cb;
 static retro_input_poll_t input_poll_cb;
 static retro_input_state_t input_state_cb;
@@ -1583,9 +1580,7 @@ size_t retro_get_memory_size(unsigned id)
 
 void retro_reset(void)
 {
-   //hack to prevent retroarch freezing when reseting in the menu but not while running with the hot key
-   rebootemu = 1;
-	//SysReset();
+	SysReset();
 }
 
 static const unsigned short retro_psx_map[] = {
@@ -2139,22 +2134,6 @@ static void update_variables(bool in_flight)
    {
       //not yet running
 
-      //bootlogo display hack
-      if (found_bios) {
-         var.value = "NULL";
-         var.key = "pcsx_rearmed_show_bios_bootlogo";
-         if (environ_cb(RETRO_ENVIRONMENT_GET_VARIABLE, &var) || var.value)
-         {
-            Config.SlowBoot = 0;
-            rebootemu = 0;
-            if (strcmp(var.value, "enabled") == 0)
-            {
-               Config.SlowBoot = 1;
-               rebootemu = 1;
-            }
-         }
-      }
-
 #if defined(LIGHTREC) || defined(NEW_DYNAREC)
       var.value = "NULL";
       var.key = "pcsx_rearmed_psxclock";
@@ -2214,15 +2193,6 @@ unsigned char axis_range_modifier(int16_t axis_value, bool is_square) {
 void retro_run(void)
 {
 	int i;
-	//SysReset must be run while core is running,Not in menu (Locks up Retroarch)
-	if (rebootemu != 0) {
-		rebootemu = 0;
-		SysReset();
-		if (!Config.HLE && !Config.SlowBoot) {
-			// skip BIOS logos
-			psxRegs.pc = psxRegs.GPR.n.ra;
-		}
-	}
 
 	if (display_internal_fps) {
 		frame_count++;
-- 
2.24.1

